## Lags Analysis

```{r}
library(tidyverse)
library(forecast)
library(plotly)
library(TSstudio)
```

```{r}
ts_plot(USgas,
        title = "US Monthly Natural Gas COnsumption",
        Ytitle = "Billion Cubic Feet",
        Xtitle = "Year",
        Xgrid = TRUE,
        Ygrid = TRUE)
```

```{r}
ts_plot(EURO_Brent,
        title = "Brent Crude Oil Prices",
        Ytitle = "US Dollars per Barrel",
        Xtitle = "Year",
        Xgrid = TRUE,
        Ygrid = TRUE)
```

```{r}
ts_plot(USVSales,
        title = "US Monthly Total Vehicle Sales",
        Ytitle = "Thousands of Units",
        Xtitle = "Year",
        Xgrid = TRUE,
        Ygrid = TRUE)
```

### The Autocorrelation Function

-   The **autocorrelation function** (**ACF**) is the main method in time series analysis for quantifying the level of correlation between a series and its lags. This method is fairly similar (both mathematically and logically) to the Pearson correlation coefficient, which we saw earlier, and can be formalized with the following expression.

![Pearson Correlation Coefficient](images/pearson%20correlation.png){width="258"}

-   The equation above represents the ACF correlation coefficient of the series with its k lag; and n, and x denote the number of observations of the series, the t observation of the series, and the mean, respectively.

```{r}
acf(USgas, lag.max = 60)
```

```{r}
acf(EURO_Brent, lag.max = 60)
```

```{r}
acf(USVSales, lag.max = 60)
```

### The Partial Autocorrelation Function

```{r}
pacf(USgas, lag.max = 60)
```

### Lag Plots

```{r}
ts_lags(USgas)
```

```{r}
ts_lags(USVSales)
```

```{r}
ts_lags(EURO_Brent)
```

```{r}
ts_lags(USgas, lags = c(12, 24, 36, 48))
```

## Causality Analysis (Naive Bayes)

### The Cross-correlation Function

```{r}
ts_info(USUnRate)
```

```{r}
ts_plot(USUnRate,
        title = "US Monthly Civllian Unemployment Rate",
        Ytitle = "Unemployment Rate (%)",
        Xgrid = TRUE,
        Ygrid = TRUE)
```

-   As you can observe in the preceding plot, the USUnRate series starts during the 1950s, as opposed to the USVSales series, which began in 1976. Therefore, before starting, let's align the two series to the same time frame using the window function:

```{r}
us_vsales <- window(USVSales, start = c(1976, 1), end = c(2019, 12))
us_unrate <- window(USVSales, start = c(1976, 1), end = c(2019, 12))
```

```{r}
plot_ly(x = time(us_vsales),
        y = us_vsales,
        type = "scatter",
        mode = "line",
        name = "Total Vehicle Sales") %>%
  add_lines(x = time(us_unrate),
            y = us_unrate,
            name = "Unemployment Rate",
            yaxis = "y2") %>%
  layout(title = "Total Monthly Vehicle Sales vs Unemployment Rate in the US",
         yaxis2 = list(overlaying = "y", side = "right", title = "Percentage", showgrid = TRUE),
         yaxis = list(title = "THousands of Units", showgrid = TRUE),
         legend = list(orientation = 'h'),
         margin = list(l = 50, r = 50, b = 50, t = 50, pad = 2))
```

```{r}
ccf(x = us_vsales, y = us_unrate, lag.max = 36)
```

```{r}
ccf_plot(x = USVSales, y = USUnRate, lags = 0:12)
```
