---
title: "project"
output: html_document
---

```{r}
library(tidyverse)
library(tidyr)
library(h2o)
library(TSstudio)
library(plotly)
library(zoo)
library(xts)
library(Quandl)
library(forecast)
library(readr)
library(naniar)
library(corrplot)
library(timetk)
```

#### Description of Dataset Columns

-   psr: personal saving rate

-   unrate: unemployment rate

-   m2: m2

-   dspic: real disposable personal income

-   pce: personal consumption expenditure

-   reer: real broad effective exchange rate

-   ir: market yield on US securities at 10-year constant maturity

-   ffer: federal funds effective rate

-   tcs: total construction spending

-   indpro:

-   cci:

```{r}
macro_monthly <- read_csv("~/Work/Data Science/Learning/Datasets/macro-monthly/macro_monthly.csv")
head(macro_monthly)
```

```{r}
names(macro_monthly)
```

```{r}
macro_monthly <- macro_monthly %>%
  # mutate(across(where(is.double), as.integer))
  mutate(across(-1, as.numeric))  # Excludes the first column

head(macro_monthly)
```

```{r}
str(macro_monthly)
```

```{r}
ts_plot(macro_monthly)
```

```{r}
colSums(is.na(macro_monthly))
```

```{r}
vis_miss(macro_monthly)
```

```{r}
macro_monthly <- macro_monthly %>%
  tidyr::fill(c(reer, tcs), .direction = "downup")  # Forward fill (Down), Backward fill (Up)
```

```{r}
colSums(is.na(macro_monthly))
```

```{r}
macro_monthly_cor <- cor(macro_monthly[,-1])
macro_monthly_cor
```

```{r}
corrplot(macro_monthly_cor)
```

-   From the correlation plot of the correlation matrix, columns *unrate and psr* are correlated with a rho=0.5. Columns *m2, dspic* and *pce each* having a strong correlation of more than 0.9. ir and ffer with rho=0.93. indpro and ccpi with rho=0.85

```{r}
macro_monthly_ts <- ts(macro_monthly, frequency = 1)
macro_monthly_ts
```

```{r}
unrate_psr <- macro_monthly %>% select(DATE, unrate, psr)
m2_dspic_pce <- macro_monthly %>% select(DATE, m2, dspic, pce)
ir_ffer <- macro_monthly %>% select(DATE, ir, ffer)
indpro_ccpi <- macro_monthly %>% select(DATE, indpro, ccpi)
m2_dspic_pce_tcs_indpro_ccpi <- macro_monthly %>% select(DATE, m2, dspic, pce, tcs, indpro, ccpi)
dspic_pce_tcs_indpro_ccpi <- macro_monthly %>% select(DATE, dspic, pce, tcs, indpro, ccpi)

head(unrate_psr)
```

```{r}
unrate_psr_xts <- as.xts(unrate_psr)
m2_dspic_pce_xts <- as.xts(m2_dspic_pce)
ir_ffer_xts <- as.xts(ir_ffer)
indpro_ccpi_xts <- as.xts(indpro_ccpi)
m2_dspic_pce_tcs_indpro_ccpi_xts <- as.xts(m2_dspic_pce_tcs_indpro_ccpi)
dspic_pce_tcs_indpro_ccpi_xts <- as.xts(dspic_pce_tcs_indpro_ccpi)

par(mfrow=c(2,2))
ts_plot(unrate_psr_xts)
ts_plot(m2_dspic_pce_xts)
ts_plot(ir_ffer_xts)
ts_plot(indpro_ccpi_xts)
# ts_plot(m2_dspic_pce_tcs_indpro_ccpi_xts)
# ts_plot(dspic_pce_tcs_indpro_ccpi_xts)
```

```{r}
names(macro_monthly)
```

```{r}
unrate <- macro_monthly %>% select(DATE, unrate)
psr <- macro_monthly %>% select(DATE, psr)
m2 <- macro_monthly %>% select(DATE, m2)
dspic <- macro_monthly %>% select(DATE, dspic)
pce <- macro_monthly %>% select(DATE, pce)
ir <- macro_monthly %>% select(DATE, ir)
ffer <- macro_monthly %>% select(DATE, ffer)
indpro <- macro_monthly %>% select(DATE, indpro)
ccpi <- macro_monthly %>% select(DATE, ccpi)

unrate_xts <- as.xts(unrate)
psr_xts <- as.xts(psr)
```

```{r}
head(unrate_xts)
```

```{r}
unrate$DATE <- as.Date(unrate$DATE)
psr$DATE <- as.Date(psr$DATE)
m2$DATE <- as.Date(m2$DATE)
dspic$DATE <- as.Date(dspic$DATE)
pce$DATE <- as.Date(pce$DATE)
ir$DATE <- as.Date(ir$DATE)
ffer$DATE <- as.Date(ffer$DATE)
indpro$DATE <- as.Date(indpro$DATE)
ccpi$DATE <- as.Date(ccpi$DATE)

head(unrate)
```

```{r}
unrate_ts <- tk_ts(unrate, 
                   start = c(lubridate::year(min(macro_monthly$DATE)), 
                             lubridate::month(min(macro_monthly$DATE))), 
                   frequency = 12)
psr_ts <- tk_ts(psr, 
                start = c(lubridate::year(min(macro_monthly$DATE)), 
                             lubridate::month(min(macro_monthly$DATE))), 
                frequency = 12)
m2_ts <- tk_ts(m2, 
               start = c(lubridate::year(min(macro_monthly$DATE)), 
                             lubridate::month(min(macro_monthly$DATE))), 
               frequency = 12)
dspic_ts <- tk_ts(dspic, 
                  start = c(lubridate::year(min(macro_monthly$DATE)), 
                             lubridate::month(min(macro_monthly$DATE))), 
                  frequency = 12)
pce_ts <- tk_ts(pce, 
                start = c(lubridate::year(min(macro_monthly$DATE)), 
                             lubridate::month(min(macro_monthly$DATE))), 
                frequency = 12)
ir_ts <- tk_ts(ir, 
               start = c(lubridate::year(min(macro_monthly$DATE)), 
                             lubridate::month(min(macro_monthly$DATE))), 
               frequency = 12)
ffer_ts <- tk_ts(ffer, 
                 start = c(lubridate::year(min(macro_monthly$DATE)), 
                             lubridate::month(min(macro_monthly$DATE))), 
                 frequency = 12)
indpro_ts <- tk_ts(indpro, 
                   start = c(lubridate::year(min(macro_monthly$DATE)), 
                             lubridate::month(min(macro_monthly$DATE))), 
                   frequency = 12)
ccpi_ts <- tk_ts(ccpi, 
                 start = c(lubridate::year(min(macro_monthly$DATE)), 
                             lubridate::month(min(macro_monthly$DATE))), 
                 frequency = 12)

ts_decompose(unrate_ts)
ts_decompose(psr_ts)
ts_decompose(m2_ts)
ts_decompose(dspic_ts)
ts_decompose(pce_ts)
ts_decompose(ir_ts)
ts_decompose(ffer_ts)
ts_decompose(indpro_ts)
ts_decompose(ccpi_ts)
```

```{r}
unrate_detrend <- unrate_ts - decompose(unrate_ts)$trend
psr_detrend <- psr_ts - decompose(psr_ts)$trend
m2_detrend <- m2_ts - decompose(m2_ts)$trend
dspic_detrend <- dspic_ts - decompose(dspic_ts)$trend
pce_detrend <- pce_ts - decompose(pce_ts)$trend
ir_detrend <- ir_ts - decompose(ir_ts)$trend
ffer_detrend <- ffer_ts - decompose(ffer_ts)$trend
indpro_detrend <- indpro_ts - decompose(indpro_ts)$trend
ccpi_detrend <- ccpi_ts - decompose(ccpi_ts)$trend

ts_seasonal(unrate_detrend)
ts_seasonal(psr_detrend)
ts_seasonal(m2_detrend)
ts_seasonal(dspic_detrend)
ts_seasonal(pce_detrend)
ts_seasonal(ir_detrend)
ts_seasonal(ffer_detrend)
ts_seasonal(indpro_detrend)
ts_seasonal(ccpi_detrend)
```

```{r}
ts_cor(unrate_ts, type = "both")
ts_cor(psr_ts, type = "both")
ts_cor(m2_ts, type = "both")
ts_cor(dspic_ts, type = "both")
ts_cor(pce_ts, type = "both")
ts_cor(ir_ts, type = "both")
ts_cor(ffer_ts, type = "both")
ts_cor(indpro_ts, type = "both")
ts_cor(ccpi_ts, type = "both")
```

```{r}
ts_lags(unrate_ts, lags = c(12, 24, 36))
ts_lags(psr_ts, lags = c(12, 24, 36))
ts_lags(m2_ts, lags = c(12, 24, 36))
ts_lags(dspic_ts, lags = c(12, 24, 36))
ts_lags(pce_ts, lags = c(12, 24, 36))
ts_lags(ir_ts, lags = c(12, 24, 36))
ts_lags(ffer_ts, lags = c(12, 24, 36))
ts_lags(indpro_ts, lags = c(12, 24, 36))
ts_lags(ccpi_ts, lags = c(12, 24, 36))
```

```{r}
simple_ma <- function(ts.obj, order) {
  lags <- order - 1
  lags <- make_lags(ts.obj = ts.obj, lags = 1)
  mean <- ts_mean(lags)
  un <- ts.union(ts.obj, mean)
  colnames(un) <- c("Original", "Transformed")
  
  return(un)
}
```

```{r}
simple_ma4_unrate <- simple_ma(unrate_ts, order = 4)
simple_ma4_psr <- simple_ma(psr_ts, order = 4)
simple_ma4_m2 <- simple_ma(m2_ts, order = 4)
simple_ma4_pce <- simple_ma(pce_ts, order = 4)
simple_ma4_dspic <- simple_ma(dspic_ts, order = 4)
simple_ma4_ir <- simple_ma(ir_ts, order = 4)
simple_ma4_ffer <- simple_ma(ffer_ts, order = 4)
simple_ma4_indpro <- simple_ma(indpro_ts, order = 4)
simple_ma4_ccpi <- simple_ma(ccpi_ts, order = 4)
```

```{r}
ts_plot(simple_ma4_unrate, type = "multiple", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(simple_ma4_psr, type = "multiple", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(simple_ma4_m2, type = "multiple", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(simple_ma4_pce, type = "multiple", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(simple_ma4_dspic, type = "multiple", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(simple_ma4_ir, type = "multiple", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(simple_ma4_ffer, type = "multiple", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(simple_ma4_indpro, type = "multiple", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(simple_ma4_ccpi, type = "multiple", Xgrid = TRUE, Ygrid = TRUE)
```

```{r}
ts_info(psr_ts)
```

```{r}
psr_cyclic <- window(psr_ts, start = c(2000, 1))
unrate_cyclic <- window(psr_ts, start = c(2000, 1))
m2_cyclic <- window(psr_ts, start = c(2000, 1))
pce_cyclic <- window(psr_ts, start = c(2000, 1))
dspic_cyclic <- window(psr_ts, start = c(2000, 1))
ir_cyclic <- window(psr_ts, start = c(2000, 1))
ffer_cyclic <- window(psr_ts, start = c(2000, 1))
indpro_cyclic <- window(psr_ts, start = c(2000, 1))
ccpi_cyclic <- window(psr_ts, start = c(2000, 1))

ts_plot(unrate_cyclic, type = "single", title = "US Monthly Unemployment Rate",
        Ytitle = "Unemployment Rate (%)",
        Xtitle = "Year", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(psr_cyclic, type = "single", title = "US Monthly Personal Saving Rate",
        Ytitle = "Personal Saving Rate (%)",
        Xtitle = "Year", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(m2_cyclic, type = "single", title = "US monthly m2",
        Ytitle = "m2",
        Xtitle = "Year", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(pce_cyclic, type = "single", title = "US Monthly Personal Consumption Expenditure",
        Ytitle = "Personal Consumption Expenditure",
        Xtitle = "Year", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(dspic_cyclic, type = "single", title = "US Monthly DIsposable Personal Income",
        Ytitle = "DIsposable Personal Income",
        Xtitle = "Year", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(ir_cyclic, type = "single", title = "US Monthly Market Yield on Securities",
        Ytitle = "Market Yield on Securities",
        Xtitle = "Year", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(ffer_cyclic, type = "single", title = "US Monthly Federal Funds Effective Rate",
        Ytitle = "Federal Funds Effective Rate (%)",
        Xtitle = "Year", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(indpro_cyclic, type = "single", title = "US Monthly ",
        Ytitle = "INDPRO",
        Xtitle = "Year", Xgrid = TRUE, Ygrid = TRUE)
ts_plot(ccpi_cyclic, type = "single", title = "US Monthly",
        Ytitle = "CCPI",
        Xtitle = "Year", Xgrid = TRUE, Ygrid = TRUE)
```

```{r}
ts_heatmap(unrate_ts, title = "Heatmap - the US Unemployment Rate")
ts_heatmap(psr_ts, title = "Heatmap - the US Personal Saving Rate")
ts_heatmap(m2_ts, title = "Heatmap - the US m2")
ts_heatmap(pce_ts, title = "Heatmap - the US Personal Consumption Expenditure")
ts_heatmap(dspic_ts, title = "Heatmap - the US DIsposable Personal Income")
ts_heatmap(ir_ts, title = "Heatmap - the US Market Yield on Securities")
ts_heatmap(ffer_ts, title = "Heatmap - the US Federal Funds Effective Rate")
ts_heatmap(indpro_ts, title = "Heatmap - the US ")
ts_heatmap(ccpi_ts, title = "Heatmap - the US ")
```

-   The columns seem to be cyclic rather than seasonal due to the bright vertical lines in each heatmap.

```{r}
x <- lapply(1:36, function(i) {
  p <- Box.test(unrate_ts, lag = i, type = "Ljung-Box")
  output <- data.frame(lag = i, p_value = p$p.value)
  return(output) 
}) %>% bind_rows

head(x)
```

```{r}
unrate_df <- data.frame(year = floor(time(unrate_ts)), month = cycle(unrate_ts), unrate = as.numeric(unrate_ts))

# Setting the month abbreviation and transforming it to a factor
unrate_df$month <- factor(month.abb[unrate_df$month], levels = month.abb)

head(unrate_df)
```

```{r}
unrate_summary <- unrate_df %>%
  group_by(month) %>%
  summarise(mean = mean(unrate), sd = sd(unrate))

unrate_summary
```

```{r}
plot_ly(data = unrate_summary,
        x = ~ month,
        y = ~ mean,
        type = "bar",
        name = "Mean"
        ) %>%
  layout(title = "The US Monthly Avearge Unemployment Rate",
         yaxis = list(title = "Mean", range = c(4, 7)))
```

```{r}
unrate_df <- data.frame(time = index(unrate_xts), UKgrid = as.numeric(unrate_xts))

str(unrate_df)
```

```{r}
unrate_df$hour <- lubridate::hour(unrate_df$time)
unrate_df$weekday <- wday(unrate_df$time, label = TRUE, abbr = TRUE)
unrate_df$month <- factor(month.abb[lubridate::month(unrate_df$time)], levels = month.abb)

head(unrate_df)
```
